'use strict';

const Q = require('q');
const repositoryManager = require('repository-manager');
const secureResourceManager = require('./secureResourceManager.js');

class RepositorySession {

	/**
	 * Creates a repository session based on the
	 * @param {UserSession} userSession - The user session which is applied to evaluate if the user has access rights.
	 */
	constructor(userSession) {
		this.user = userSession;
	}

	createEmptyResource(pathInfo) {
		return repositoryManager.createEmptyResource(pathInfo);
	};

	createResource(pathInfo) {
		return repositoryManager.createResource(pathInfo);
	};

	resolve(pathInfo) {
		let deferred = Q.defer();
		let sessionUser = this.user;
		repositoryManager.resolve(pathInfo).then(function(resource) {
			secureResourceManager.secureResource(resource, sessionUser).then(function(resource) {
				deferred.resolve(resource);
			}).fail(deferred.reject);
		}).fail(deferred.reject);
		return deferred.promise;
	};
}


module.exports = RepositorySession;